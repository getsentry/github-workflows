name: 'Danger JS'
description: 'Runs DangerJS with a pre-configured set of rules on a Pull Request'
author: 'Sentry'

inputs:
  api-token:
    description: 'Token for the repo. Can be passed in using {{ secrets.GITHUB_TOKEN }}'
    required: false
    default: ${{ github.token }}

outputs:
  outcome:
    description: 'Whether the Danger run finished successfully. Possible values are success, failure, cancelled, or skipped.'
    value: ${{ steps.danger.outcome }}

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ inputs.api-token }}
        fetch-depth: 0

    # Using a pre-built docker image in GitHub container registry instead of NPM to reduce possible attack vectors.
    - name: Run DangerJS
      id: danger
      shell: bash
      run: |
        docker run \
          --volume ${{ github.workspace }}:/github/workspace \
          --volume ${{ github.action_path }}:${{ github.action_path }} \
          --volume ${{ github.event_path }}:${{ github.event_path }} \
          --workdir /github/workspace \
          --user $UID \
          -e "INPUT_ARGS" -e "GITHUB_JOB" -e "GITHUB_REF" -e "GITHUB_SHA" -e "GITHUB_REPOSITORY" -e "GITHUB_REPOSITORY_OWNER" -e "GITHUB_RUN_ID" -e "GITHUB_RUN_NUMBER" -e "GITHUB_RETENTION_DAYS" -e "GITHUB_RUN_ATTEMPT" -e "GITHUB_ACTOR" -e "GITHUB_TRIGGERING_ACTOR" -e "GITHUB_WORKFLOW" -e "GITHUB_HEAD_REF" -e "GITHUB_BASE_REF" -e "GITHUB_EVENT_NAME" -e "GITHUB_SERVER_URL" -e "GITHUB_API_URL" -e "GITHUB_GRAPHQL_URL" -e "GITHUB_REF_NAME" -e "GITHUB_REF_PROTECTED" -e "GITHUB_REF_TYPE" -e "GITHUB_WORKSPACE" -e "GITHUB_ACTION" -e "GITHUB_EVENT_PATH" -e "GITHUB_ACTION_REPOSITORY" -e "GITHUB_ACTION_REF" -e "GITHUB_PATH" -e "GITHUB_ENV" -e "GITHUB_STEP_SUMMARY" -e "RUNNER_OS" -e "RUNNER_ARCH" -e "RUNNER_NAME" -e "RUNNER_TOOL_CACHE" -e "RUNNER_TEMP" -e "RUNNER_WORKSPACE" -e "ACTIONS_RUNTIME_URL" -e "ACTIONS_RUNTIME_TOKEN" -e "ACTIONS_CACHE_URL" -e GITHUB_ACTIONS=true -e CI=true \
          -e GITHUB_TOKEN="${{ github.token }}" \
          -e DANGER_DISABLE_TRANSPILATION="true" \
          ghcr.io/danger/danger-js:11.3.1 \
          --failOnErrors --dangerfile ${{ github.action_path }}/dangerfile.js